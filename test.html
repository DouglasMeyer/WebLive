<!DOCTYPE html>
<html>
  <head>
    <title>WebLive - test</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
  </head>
  <body>
    <script>
      Promise.prototype.log = function(){
        return this
          .then((json) => {
            const pre = document.createElement('pre');
            document.body.appendChild(pre);
            pre.innerText = JSON.stringify(json);
          })
          .catch((error) => {
            const pre = document.createElement('pre');
            document.body.appendChild(pre);
            pre.style.color = "#C00"
            pre.innerText = JSON.stringify(error);
          });
      };
      
      function gitFetch(path, options){
        return fetch(`https://api.github.com/repos/DouglasMeyer/WebLive/git${path}`, options);
      }
      
      let commitSha, treeSha;
      gitFetch('/refs')
        .then(response => response.json())
        .log()
        .then((refs) => {
          commitSha = refs.find(({ ref }) => ref === 'refs/heads/gh-pages').object.sha;
          return gitFetch(`/commits/${commitSha}`);
        })
        .then(response => response.json())
        .then((commit) => {
          treeSha = commit.tree.sha;
          return gitFetch('/blobs',
            {
              method: 'post',
              body: {
                content: `some stuff`
              }
            }
          );
        })
        .then(response => response.json())
        .then((blob) => {
          return gitFetch("/trees",
            {
              method: "POST",
              body: {
                "base_tree": treeSha,
                "tree": [
                  {
                    "path": "test.txt",
                    "mode": "100644",
                    "type": "blob",
                    "sha": blob.sha
                  }
                ]
              }
            }
          );
        })
        .then(response => response.json())
        .log()
        .then((tree) => {
          return gitFetch("/commits",
            {
              method: "POST",
              body: {
                "message": `Test commit ${new Date}`,
                "author": {
                  "name": "Douglas Meyer",
                  "email": "me@douglas-meyer.name"
    //               "date": "2008-07-09T16:13:30+12:00"
                },
                "parents": [ commitSha ]
//                   "7d1b31e74ee336d15cbd21741bc88a537ed063a0"
//                 ],
                "tree": tree.sha,
    //             "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABAQAdFiEESn/54jMNIrGSE6Tp6cQjvhfv7nAFAlnT71cACgkQ6cQjvhfv\n7nCWwA//XVqBKWO0zF+bZl6pggvky3Oc2j1pNFuRWZ29LXpNuD5WUGXGG209B0hI\nDkmcGk19ZKUTnEUJV2Xd0R7AW01S/YSub7OYcgBkI7qUE13FVHN5ln1KvH2all2n\n2+JCV1HcJLEoTjqIFZSSu/sMdhkLQ9/NsmMAzpf/iIM0nQOyU4YRex9eD1bYj6nA\nOQPIDdAuaTQj1gFPHYLzM4zJnCqGdRlg0sOM/zC5apBNzIwlgREatOYQSCfCKV7k\nnrU34X8b9BzQaUx48Qa+Dmfn5KQ8dl27RNeWAqlkuWyv3pUauH9UeYW+KyuJeMkU\n+NyHgAsWFaCFl23kCHThbLStMZOYEnGagrd0hnm1TPS4GJkV4wfYMwnI4KuSlHKB\njHl3Js9vNzEUQipQJbgCgTiWvRJoK3ENwBTMVkKHaqT4x9U4Jk/XZB6Q8MA09ezJ\n3QgiTjTAGcum9E9QiJqMYdWQPWkaBIRRz5cET6HPB48YNXAAUsfmuYsGrnVLYbG+\nUpC6I97VybYHTy2O9XSGoaLeMI9CsFn38ycAxxbWagk5mhclNTP5mezIq6wKSwmr\nX11FW3n1J23fWZn5HJMBsRnUCgzqzX3871IqLYHqRJ/bpZ4h20RhTyPj5c/z7QXp\neSakNQMfbbMcljkha+ZMuVQX1K9aRlVqbmv3ZMWh+OijLYVU2bc=\n=5Io4\n-----END PGP SIGNATURE-----\n"
              }
            }
          );
        })
        .log();
    </script>
  </body>
</html>
